<!DOCTYPE HTML>
<html>
    <head>
        <meta charset="utf-8">
    </head>
    <body>
        <h2> Load .class or .jar </h2>
        <input id="fileInput" type="file">
        <br>
        <br>
        <span> Command line arguments: </span>
        <span id="commandLineArguments">
            <button id="addCommandLineArgument"> + </button>
        </span>
        <br>
        <br>
        <button id="doRun">Run selected file</button>
        <br>
        <br>
        <h4 id="frameName"> Untitled window </h4>
        <canvas id="outputCanvas" width="800" height="600" style="border: 1px solid black;" tabindex="0"></canvas>
        <br>
        <br>
        <h2> Output </h2>
        <textarea id="outputTextarea" style="width: 40vw; height: 50vh; resize: none;" spellcheck="false" readonly></textarea>
        <br>
        <button id="clearOutput"> Clear logs </button>

        <script type="module">
            let worker = new Worker("worker.js?nc=" + Date.now(), { type: "module" });

            const canvas = document.getElementById("outputCanvas");
            const ctx = canvas.getContext('2d');

            worker.addEventListener("message", function(e) {
                function handleCanvasOperation(e) {
                    switch (e.type) {
                        case "drawLine":
                            ctx.beginPath();
                            ctx.moveTo(e.x1, e.y1);
                            ctx.lineTo(e.x2, e.y2);
                            ctx.closePath();
                            ctx.stroke();
                            break;
                        case "fillRect":
                            ctx.fillRect(e.x, e.y, e.width, e.height);
                            break;
                        case "setColor":
                            let color = "rgba(" + e.r + ", " + e.g + ", " + e.b + ", " + e.a + ")";
                            ctx.fillStyle = color;
                            ctx.strokeStyle = color;
                            break;
                        case "translate":
                            ctx.translate(e.x, e.y);
                            break;
                        case "drawString":
                            ctx.fillText(e.text, e.x, e.y);
                            break;
                        case "setFont":
                            ctx.font = e.modifiers + e.size + "px " + e.name;
                            break;
                    }
                }

                switch (e.data.type) {
                    case "textOutput":
                        document.getElementById("outputTextarea").value += e.data.data;
                        break;
                    case "setFrameName":
                        document.getElementById("frameName").innerText = e.data.name;
                        break;

                    case "flushPaint":
                        ctx.fillStyle = "#FFF";
                        ctx.fillRect(0, 0, ctx.canvas.width, ctx.canvas.height);
                        let data = e.data.data;
                        for (let i = 0; i < data.length; i ++) {
                            handleCanvasOperation(data[i]);
                        }
                        break;
                }
            });

            canvas.addEventListener("mousemove", function(e) {
                let x = e.offsetX;
                let y = e.offsetY;
                worker.postMessage({
                    "type": "mouseMove",
                    "x": x,
                    "y": y,
                });
            });

            canvas.addEventListener("mousedown", function(e) {
                let x = e.offsetX;
                let y = e.offsetY;
                // TODO buttons?
                worker.postMessage({
                    "type": "mouseDown",
                    "x": x,
                    "y": y,
                });
            });

            canvas.addEventListener("mouseup", function(e) {
                let x = e.offsetX;
                let y = e.offsetY;
                // TODO buttons?
                worker.postMessage({
                    "type": "mouseUp",
                    "x": x,
                    "y": y,
                });
            });

            function init() {
                let fileInput = document.getElementById("fileInput");
                let commandLineArguments = document.getElementById("commandLineArguments");
                let addCommandLineArgument = document.getElementById("addCommandLineArgument");
                let doRun = document.getElementById("doRun");
                let clearOutput = document.getElementById("clearOutput");

                doRun.disabled = true;
                document.getElementById("outputTextarea").value = "$ ";

                fileInput.addEventListener("change", function(e) {
                    let file = e.target.files[0];

                    let reader = new FileReader();
                    reader.readAsArrayBuffer(file);

                    reader.addEventListener("loadend", function(e) {
                        worker.postMessage({
                            "type": "fileUpload",
                            "fileName": file.name,
                            "fileData": new Uint8Array(reader.result),
                        });

                        // Enable button once a file is selected
                        doRun.disabled = false;
                    });
                });

                addCommandLineArgument.addEventListener("click", function(e) {
                    let child = document.createElement("span");
                    child.style.border = "1px solid black";
                    child.style.padding = "4px";
                    child.style.margin = "4px";

                    let input = document.createElement("input");
                    input.type = "text";
                    input.style.width = "80px";

                    let removeArg = document.createElement("button");
                    removeArg.innerText = "-";
                    removeArg.addEventListener("click", function(e) {
                        child.parentNode.removeChild(child);
                    });

                    child.appendChild(input);
                    child.appendChild(removeArg);

                    commandLineArguments.insertBefore(child, addCommandLineArgument);
                });

                doRun.addEventListener("click", function(e) {
                    let args = [];
                    for (let i = 0; i < commandLineArguments.children.length - 1; i ++) {
                        let child = commandLineArguments.children[i];
                        args.push(child.children[0].value);
                    }

                    worker.postMessage({
                        "type": "runFile",
                        "args": args,
                    });
                });

                clearOutput.addEventListener("click", function(e) {
                    document.getElementById("outputTextarea").value = "$ ";
                });
            }

            init();
        </script>
    </body>
</html>

